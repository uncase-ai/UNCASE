# ═══════════════════════════════════════════════════════════════
# UNCASE — Docker Compose
#
# Uso:
#   docker compose up -d                  # API + PostgreSQL
#   docker compose --profile ml up -d     # + MLflow tracking
#   docker compose --profile gpu up -d    # + API con GPU
#   docker compose down                   # Detener todo
#   docker compose logs -f api            # Ver logs de la API
# ═══════════════════════════════════════════════════════════════

services:
  # ── API FastAPI ────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: uncase-api
    ports:
      - "${API_PORT:-8000}:8000"
    env_file: .env
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-uncase}:${POSTGRES_PASSWORD:-uncase}@postgres:5432/${POSTGRES_DB:-uncase}
      - REDIS_URL=redis://redis:6379/0
      - UNCASE_ENV=${UNCASE_ENV:-development}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - models_data:/app/models
      - exports_data:/app/exports

  # ── PostgreSQL ─────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: uncase-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-uncase}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-uncase}
      POSTGRES_DB: ${POSTGRES_DB:-uncase}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-uncase}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ── Redis (rate limiting, caching) ────────────────────────
  redis:
    image: redis:7-alpine
    container_name: uncase-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ── MLflow Tracking (perfil ml) ────────────────────────────
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.19.0
    container_name: uncase-mlflow
    profiles: ["ml"]
    ports:
      - "${MLFLOW_PORT:-5000}:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://${POSTGRES_USER:-uncase}:${POSTGRES_PASSWORD:-uncase}@postgres:5432/${POSTGRES_DB:-uncase}
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - mlflow_data:/mlflow/artifacts
    command: >
      mlflow server
        --host 0.0.0.0
        --port 5000
        --backend-store-uri postgresql://${POSTGRES_USER:-uncase}:${POSTGRES_PASSWORD:-uncase}@postgres:5432/${POSTGRES_DB:-uncase}
        --default-artifact-root /mlflow/artifacts
    restart: unless-stopped

  # ── API con GPU (perfil gpu) ───────────────────────────────
  api-gpu:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: nvidia/cuda:12.4.1-runtime-ubuntu22.04
        INSTALL_EXTRAS: all
    container_name: uncase-api-gpu
    profiles: ["gpu"]
    ports:
      - "${API_GPU_PORT:-8001}:8000"
    env_file: .env
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-uncase}:${POSTGRES_PASSWORD:-uncase}@postgres:5432/${POSTGRES_DB:-uncase}
      - UNCASE_ENV=${UNCASE_ENV:-development}
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    volumes:
      - models_data:/app/models
      - exports_data:/app/exports

  # ── Prometheus (perfil observability) ──────────────────────
  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: uncase-prometheus
    profiles: ["observability"]
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
    depends_on:
      api:
        condition: service_started
    restart: unless-stopped

  # ── Grafana (perfil observability) ────────────────────────
  grafana:
    image: grafana/grafana:11.4.0
    container_name: uncase-grafana
    profiles: ["observability"]
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-uncase}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  models_data:
    driver: local
  exports_data:
    driver: local
  mlflow_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
